kind: Deployment
apiVersion: extensions/v1beta1

metadata:
  name: arc-api
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"

spec:
  replicas: {{ .Values.api.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 2
  template:
    metadata:
      labels:
        app: arc-api
    spec:
      volumes:
        - name: secrets
          secret:
            secretName: arc
      containers:
        - name: api
          image: {{ .Values.api.image.repository }}:{{ .Values.api.image.tag }}
          imagePullPolicy: {{ .Values.api.image.pullPolicy }}
          ports:
            - name: api
              containerPort: {{ .Values.api.service.internalPort }}
          readinessProbe:
            httpGet:
              path: /readiness
              port: {{ .Values.api.service.internalPort }}
            initialDelaySeconds: 5
            timeoutSeconds: 1
          livenessProbe:
            httpGet:
              path: /healthcheck
              port: {{ .Values.api.service.internalPort }}
            initialDelaySeconds: 20
            timeoutSeconds: 5
          env:
            - name: ARC_LISTEN
              value: 0.0.0.0:{{ .Values.api.service.internalPort }}
            - name: ARC_ENV
              value: production
            - name: ARC_ENDPOINT
              value: tls://mosquitto:8883
            - name: ARC_PKI_CA_CERT
              value: /secrets/ca.crt
            - name: ARC_PKI_CA_KEY
              value: /secrets/ca.key
            - name: ARC_LOG_LEVEL
              value: {{ .Values.logLevel }}
{{- if .Values.agentUpdateURL }}
            - name: ARC_AGENT_UPDATE_URL
              value: {{ .Values.agentUpdateURL }}
{{- end }}
{{- if .Values.agentEndpointURL }}
            - name: ARC_AGENT_ENDPOINT_URL
              value: {{ .Values.agentEndpointURL }}
{{- end }}
            - name: COMMON_NAME # use pod name as common name
              valueFrom: { fieldRef: { fieldPath: metadata.name } }
            - name: DBUSER
              value: postgres
            - name: DBHOST
              value: {{ template "postgresql.fullname" . }}
            - name: DBPASSWORD
              valueFrom: { secretKeyRef:    { name: {{ template "postgresql.fullname" . }}, key: postgres-password } }
            - name: ARC_KEYSTONE_ENDPOINT
              value: {{ .Values.keystoneEndpoint }}
          volumeMounts:
            - name: secrets
              mountPath: /secrets
              readOnly: true
{{- if .Values.backup.enabled }}
        - image: {{.Values.backup.repository}}:{{.Values.backup.image_version}}
          name: backup
          env:
            - name: MY_POD_NAME
              value: postgres-backup-{{.Values.name}}
            - name: MY_POD_NAMESPACE
              value: {{.Release.Namespace}}
            - name: OS_AUTH_URL
              value: {{.Values.backup.os_auth_url}}
            - name: OS_AUTH_VERSION
              value: {{.Values.backup.os_auth_version | quote}}
            - name: OS_IDENTITY_API_VERSION
              value: {{.Values.backup.os_identity_api_version | quote}}
            - name: OS_USERNAME
              value: {{.Values.backup.os_username}}
            - name: OS_USER_DOMAIN_NAME
              value: {{.Values.backup.os_user_domain}}
            - name: OS_PROJECT_NAME
              value: {{.Values.backup.os_project_name}}
            - name: OS_PROJECT_DOMAIN_NAME
              value: {{.Values.backup.os_project_domain}}
            - name: OS_REGION_NAME
              value: {{.Values.backup.os_region_name}}
            - name: OS_PASSWORD
              value: {{.Values.backup.os_password | quote}}
            - name: BACKUP_PGSQL_FULL
              value: {{.Values.backup.interval_full | quote}}
            - name: BACKUP_PGSQL_INCR
              value: {{.Values.backup.interval_incr | quote}}
{{- end }}

