apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule

metadata:
  name: openstack-sre-alerts
  labels:
    tier: sre
    type: alerting-rules
    prometheus: {{ required ".Values.prometheus.alerts missing" .Values.prometheus.alerts }}

spec:
  # https://landing.google.com/sre/workbook/chapters/alerting-on-slos/#short_and_long_windows_for_alerting
  groups:
  - name: openstack-sre.alerts
    rules:
    - alert: ApiAvailabilityWarning
      expr: (1 - global:api_errors_per_request_sli:ratio_rate1h) *100 <= on (ingress,region) global:api_availability_warning_slo:percent
      labels:
        context: availability
        service: "{{`{{$labels.ingress}}`}}"
        severity: warning
        tier: sre
      annotations:
        summary: "An API fell below availability warning SLO in the last hour"
        description: "{{`{{$labels.ingress}}`}} fell below availability warning SLO in the last hour."

    - alert: ApiAvailabilityCritical
      expr: (1 - global:api_errors_per_request_sli:ratio_rate1h) *100 <= on (ingress,region) global:api_availability_critical_slo:percent
      labels:
        context: availability
        service: "{{`{{$labels.ingress}}`}}"
        severity: critical
        tier: sre
      annotations:
        summary: "An api fell below availability critical SLO in the last hour"
        description: "{{`{{$labels.ingress}}`}} fell below availability critical SLO in the last hour."
