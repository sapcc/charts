#!/bin/bash

# keep restarting until storage becomes available
if [ ! -f /swift-drive-state/flag-ready ]; then
    echo "waiting for /swift-drive-state/flag-ready" >&2
    exit 1
fi

# shared initialization for all containers
. /swift-bin/common.sh

# create the marker file for the unmount-helper that marks when this service was started
mkdir -p /swift-drive-state/service-startup-time
MARKER="/swift-drive-state/service-startup-time/rsyncd"
touch "${MARKER}"

function _start_application {
    if [ "$RSYNC_COMPAT" = "true" ]; then
      apt-get update && apt-get -y install build-essential && apt-get clean
      cd /tmp
      curl http://rsync.samba.org/ftp/rsync/src/rsync-3.1.1.tar.gz | tar xz
      cd *rsync*
      ./configure
      make
      cp rsync /usr/bin/rsync
      chmod +x /usr/bin/rsync
      make clean
    fi

    bash /swift-bin/unmount-helper "${MARKER}" &
    /usr/bin/rsync --daemon --config=/swift-etc/rsyncd.conf --no-detach
}

start_application
